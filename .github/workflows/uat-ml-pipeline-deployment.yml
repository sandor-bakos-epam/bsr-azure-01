name: GitHub Actions - Azure Machine Learning deploy - Demo
run-name: ${{ github.actor }} is testing out Azure Machine Learning deployment with GitHub Actions ðŸš€
on: 
  push: 
    paths:
      - '.github/workflows/uat-ml-pipeline-deploy.yml'

permissions:
      id-token: write
      contents: read

env:
  artifactDirectory: "release-artifact-folder"
  mlPath: "models/pipelines"

jobs:

  download-release:
    name: 'Latest Release Import to Azure Machine Learning'
    runs-on: windows-latest
    environment: uat

    steps:
    - name: Clean Directory
      continue-on-error: true
      run: rm ${{ env.artifactDirectory }} -r -force -ErrorAction SilentlyContinue      
      
    - name: Download latest release
      uses: robinraju/release-downloader@v1.7
      with:
        latest: true
        fileName: "*.zip"
        out-file-path: ${{ env.artifactDirectory }}
        
    - name: Check downloaded files
      run: dir ; dir ${{ env.artifactDirectory }}

    - name: Unzip Release Artifact
      run: cd ${{ env.artifactDirectory }}; Get-ChildItem -Filter *.zip | Expand-Archive -DestinationPath . -Force 
    
    - name: 'Az CLI login'
      uses: azure/login@v1
      with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
    - name: 'Run Azure CLI commands'
      run: |
          az account show
          az group list
          pwd
    - name: Iterate over ${{ env.mlPath }}
      run: |
          foreach($folder in Get-ChildItem -path ${{ env.mlPath }} -Directory -Name)
          {
            Get-ChildItem -Path $folder -Name
            "Only YAML files:"
            Get-ChildItem -Path $folder\*.yml -Name
          }
